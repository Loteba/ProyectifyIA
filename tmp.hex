0000	2f 2f 20 62 61 63 6b 65  6e 64 2f 63 6f 6e 74 72   // backend/contr
0010	6f 6c 6c 65 72 73 2f 70  72 69 76 61 63 79 43 6f   ollers/privacyCo
0020	6e 74 72 6f 6c 6c 65 72  2e 6a 73 0a 63 6f 6e 73   ntroller.js.cons
0030	74 20 61 73 79 6e 63 48  61 6e 64 6c 65 72 20 3d   t asyncHandler =
0040	20 72 65 71 75 69 72 65  28 27 65 78 70 72 65 73    require('expres
0050	73 2d 61 73 79 6e 63 2d  68 61 6e 64 6c 65 72 27   s-async-handler'
0060	29 3b 0a 63 6f 6e 73 74  20 62 63 72 79 70 74 20   );.const bcrypt 
0070	3d 20 72 65 71 75 69 72  65 28 27 62 63 72 79 70   = require('bcryp
0080	74 6a 73 27 29 3b 0a 63  6f 6e 73 74 20 55 73 65   tjs');.const Use
0090	72 20 3d 20 72 65 71 75  69 72 65 28 27 2e 2e 2f   r = require('../
00a0	6d 6f 64 65 6c 73 2f 75  73 65 72 4d 6f 64 65 6c   models/userModel
00b0	27 29 3b 0a 63 6f 6e 73  74 20 50 72 6f 6a 65 63   ');.const Projec
00c0	74 20 3d 20 72 65 71 75  69 72 65 28 27 2e 2e 2f   t = require('../
00d0	6d 6f 64 65 6c 73 2f 70  72 6f 6a 65 63 74 4d 6f   models/projectMo
00e0	64 65 6c 27 29 3b 0a 63  6f 6e 73 74 20 54 61 73   del');.const Tas
00f0	6b 20 3d 20 72 65 71 75  69 72 65 28 27 2e 2e 2f   k = require('../
0100	6d 6f 64 65 6c 73 2f 74  61 73 6b 4d 6f 64 65 6c   models/taskModel
0110	27 29 3b 0a 63 6f 6e 73  74 20 4c 69 62 72 61 72   ');.const Librar
0120	79 49 74 65 6d 20 3d 20  72 65 71 75 69 72 65 28   yItem = require(
0130	27 2e 2e 2f 6d 6f 64 65  6c 73 2f 6c 69 62 72 61   '../models/libra
0140	72 79 49 74 65 6d 4d 6f  64 65 6c 27 29 3b 0a 63   ryItemModel');.c
0150	6f 6e 73 74 20 7b 20 67  65 74 44 72 6f 70 62 6f   onst { getDropbo
0160	78 43 6c 69 65 6e 74 20  7d 20 3d 20 72 65 71 75   xClient } = requ
0170	69 72 65 28 27 2e 2e 2f  73 65 72 76 69 63 65 73   ire('../services
0180	2f 64 72 6f 70 62 6f 78  43 6c 69 65 6e 74 27 29   /dropboxClient')
0190	3b 0a 0a 2f 2f 20 40 64  65 73 63 20 20 20 20 4f   ;..// @desc    O
01a0	62 74 65 6e 65 72 20 70  65 72 66 69 6c 20 64 65   btener perfil de
01b0	6c 20 75 73 75 61 72 69  6f 20 61 75 74 65 6e 74   l usuario autent
01c0	69 63 61 64 6f 0a 2f 2f  20 40 72 6f 75 74 65 20   icado.// @route 
01d0	20 20 47 45 54 20 2f 61  70 69 2f 75 73 65 72 73     GET /api/users
01e0	2f 6d 65 0a 2f 2f 20 40  61 63 63 65 73 73 20 20   /me.// @access  
01f0	50 72 69 76 61 64 6f 0a  63 6f 6e 73 74 20 67 65   Privado.const ge
0200	74 4d 65 20 3d 20 61 73  79 6e 63 48 61 6e 64 6c   tMe = asyncHandl
0210	65 72 28 61 73 79 6e 63  20 28 72 65 71 2c 20 72   er(async (req, r
0220	65 73 29 20 3d 3e 20 7b  0a 20 20 72 65 73 2e 6a   es) => {.  res.j
0230	73 6f 6e 28 72 65 71 2e  75 73 65 72 29 3b 0a 7d   son(req.user);.}
0240	29 3b 0a 0a 2f 2f 20 40  64 65 73 63 20 20 20 20   );..// @desc    
0250	45 6c 69 6d 69 6e 61 72  20 63 75 65 6e 74 61 20   Eliminar cuenta 
0260	64 65 6c 20 75 73 75 61  72 69 6f 20 28 4c 50 44   del usuario (LPD
0270	50 20 2d 20 64 65 72 65  63 68 6f 20 64 65 20 73   P - derecho de s
0280	75 70 72 65 73 69 c3 83  c2 b3 6e 29 0a 2f 2f 20   upresi....n).// 
0290	40 72 6f 75 74 65 20 20  20 44 45 4c 45 54 45 20   @route   DELETE 
02a0	2f 61 70 69 2f 75 73 65  72 73 2f 6d 65 0a 2f 2f   /api/users/me.//
02b0	20 40 61 63 63 65 73 73  20 20 50 72 69 76 61 64    @access  Privad
02c0	6f 0a 63 6f 6e 73 74 20  64 65 6c 65 74 65 4d 65   o.const deleteMe
02d0	20 3d 20 61 73 79 6e 63  48 61 6e 64 6c 65 72 28    = asyncHandler(
02e0	61 73 79 6e 63 20 28 72  65 71 2c 20 72 65 73 29   async (req, res)
02f0	20 3d 3e 20 7b 0a 20 20  63 6f 6e 73 74 20 75 73    => {.  const us
0300	65 72 49 64 20 3d 20 72  65 71 2e 75 73 65 72 2e   erId = req.user.
0310	5f 69 64 3b 0a 0a 20 20  61 77 61 69 74 20 50 72   _id;..  await Pr
0320	6f 6d 69 73 65 2e 61 6c  6c 28 5b 0a 20 20 20 20   omise.all([.    
0330	50 72 6f 6a 65 63 74 2e  64 65 6c 65 74 65 4d 61   Project.deleteMa
0340	6e 79 28 7b 20 75 73 65  72 3a 20 75 73 65 72 49   ny({ user: userI
0350	64 20 7d 29 2c 0a 20 20  20 20 54 61 73 6b 2e 64   d }),.    Task.d
0360	65 6c 65 74 65 4d 61 6e  79 28 7b 20 75 73 65 72   eleteMany({ user
0370	3a 20 75 73 65 72 49 64  20 7d 29 2c 0a 20 20 20   : userId }),.   
0380	20 4c 69 62 72 61 72 79  49 74 65 6d 2e 64 65 6c    LibraryItem.del
0390	65 74 65 4d 61 6e 79 28  7b 20 75 73 65 72 3a 20   eteMany({ user: 
03a0	75 73 65 72 49 64 20 7d  29 2c 0a 20 20 5d 29 3b   userId }),.  ]);
03b0	0a 0a 20 20 61 77 61 69  74 20 55 73 65 72 2e 64   ..  await User.d
03c0	65 6c 65 74 65 4f 6e 65  28 7b 20 5f 69 64 3a 20   eleteOne({ _id: 
03d0	75 73 65 72 49 64 20 7d  29 3b 0a 0a 20 20 72 65   userId });..  re
03e0	74 75 72 6e 20 72 65 73  2e 73 74 61 74 75 73 28   turn res.status(
03f0	32 30 34 29 2e 73 65 6e  64 28 29 3b 0a 7d 29 3b   204).send();.});
0400	0a 0a 6d 6f 64 75 6c 65  2e 65 78 70 6f 72 74 73   ..module.exports
0410	20 3d 20 7b 20 67 65 74  4d 65 2c 20 64 65 6c 65    = { getMe, dele
0420	74 65 4d 65 20 7d 3b 0a  2f 2f 20 40 64 65 73 63   teMe };.// @desc
0430	20 20 20 20 41 63 74 75  61 6c 69 7a 61 72 20 70       Actualizar p
0440	65 72 66 69 6c 20 64 65  6c 20 75 73 75 61 72 69   erfil del usuari
0450	6f 20 61 75 74 65 6e 74  69 63 61 64 6f 20 28 6e   o autenticado (n
0460	6f 6d 62 72 65 2c 20 65  6d 61 69 6c 20 79 2f 6f   ombre, email y/o
0470	20 63 6f 6e 74 72 61 73  65 c3 83 c2 b1 61 29 0a    contrase....a).
0480	2f 2f 20 40 72 6f 75 74  65 20 20 20 50 55 54 20   // @route   PUT 
0490	2f 61 70 69 2f 75 73 65  72 73 2f 6d 65 0a 2f 2f   /api/users/me.//
04a0	20 40 61 63 63 65 73 73  20 20 50 72 69 76 61 64    @access  Privad
04b0	6f 0a 63 6f 6e 73 74 20  75 70 64 61 74 65 4d 65   o.const updateMe
04c0	20 3d 20 61 73 79 6e 63  48 61 6e 64 6c 65 72 28    = asyncHandler(
04d0	61 73 79 6e 63 20 28 72  65 71 2c 20 72 65 73 29   async (req, res)
04e0	20 3d 3e 20 7b 0a 20 20  63 6f 6e 73 74 20 75 73    => {.  const us
04f0	65 72 49 64 20 3d 20 72  65 71 2e 75 73 65 72 2e   erId = req.user.
0500	5f 69 64 3b 0a 20 20 63  6f 6e 73 74 20 7b 20 6e   _id;.  const { n
0510	61 6d 65 2c 20 65 6d 61  69 6c 2c 20 63 75 72 72   ame, email, curr
0520	65 6e 74 50 61 73 73 77  6f 72 64 2c 20 6e 65 77   entPassword, new
0530	50 61 73 73 77 6f 72 64  20 7d 20 3d 20 72 65 71   Password } = req
0540	2e 62 6f 64 79 20 7c 7c  20 7b 7d 3b 0a 0a 20 20   .body || {};..  
0550	63 6f 6e 73 74 20 75 73  65 72 20 3d 20 61 77 61   const user = awa
0560	69 74 20 55 73 65 72 2e  66 69 6e 64 42 79 49 64   it User.findById
0570	28 75 73 65 72 49 64 29  3b 0a 20 20 69 66 20 28   (userId);.  if (
0580	21 75 73 65 72 29 20 7b  20 72 65 73 2e 73 74 61   !user) { res.sta
0590	74 75 73 28 34 30 34 29  3b 20 74 68 72 6f 77 20   tus(404); throw 
05a0	6e 65 77 20 45 72 72 6f  72 28 27 55 73 75 61 72   new Error('Usuar
05b0	69 6f 20 6e 6f 20 65 6e  63 6f 6e 74 72 61 64 6f   io no encontrado
05c0	27 29 3b 20 7d 0a 0a 20  20 2f 2f 20 53 69 20 73   '); }..  // Si s
05d0	65 20 69 6e 74 65 6e 74  61 20 63 61 6d 62 69 61   e intenta cambia
05e0	72 20 65 6c 20 65 6d 61  69 6c 2c 20 65 78 69 67   r el email, exig
05f0	69 72 20 63 6f 6e 74 72  61 73 65 c3 83 c2 b1 61   ir contrase....a
0600	20 61 63 74 75 61 6c 20  79 20 75 6e 69 63 69 64    actual y unicid
0610	61 64 0a 20 20 69 66 20  28 74 79 70 65 6f 66 20   ad.  if (typeof 
0620	65 6d 61 69 6c 20 3d 3d  3d 20 27 73 74 72 69 6e   email === 'strin
0630	67 27 20 26 26 20 65 6d  61 69 6c 2e 74 72 69 6d   g' && email.trim
0640	28 29 20 26 26 20 65 6d  61 69 6c 20 21 3d 3d 20   () && email !== 
0650	75 73 65 72 2e 65 6d 61  69 6c 29 20 7b 0a 20 20   user.email) {.  
0660	20 20 63 6f 6e 73 74 20  6e 65 77 45 6d 61 69 6c     const newEmail
0670	20 3d 20 65 6d 61 69 6c  2e 74 72 69 6d 28 29 3b    = email.trim();
0680	0a 20 20 20 20 63 6f 6e  73 74 20 65 78 69 73 74   .    const exist
0690	73 20 3d 20 61 77 61 69  74 20 55 73 65 72 2e 66   s = await User.f
06a0	69 6e 64 4f 6e 65 28 7b  20 65 6d 61 69 6c 3a 20   indOne({ email: 
06b0	6e 65 77 45 6d 61 69 6c  2c 20 5f 69 64 3a 20 7b   newEmail, _id: {
06c0	20 24 6e 65 3a 20 75 73  65 72 49 64 20 7d 20 7d    $ne: userId } }
06d0	29 3b 0a 20 20 20 20 69  66 20 28 65 78 69 73 74   );.    if (exist
06e0	73 29 20 7b 20 72 65 73  2e 73 74 61 74 75 73 28   s) { res.status(
06f0	34 30 30 29 3b 20 74 68  72 6f 77 20 6e 65 77 20   400); throw new 
0700	45 72 72 6f 72 28 27 45  6c 20 65 6d 61 69 6c 20   Error('El email 
0710	79 61 20 65 73 74 c3 83  c2 a1 20 65 6e 20 75 73   ya est.... en us
0720	6f 27 29 3b 20 7d 0a 20  20 20 20 69 66 20 28 21   o'); }.    if (!
0730	63 75 72 72 65 6e 74 50  61 73 73 77 6f 72 64 29   currentPassword)
0740	20 7b 20 72 65 73 2e 73  74 61 74 75 73 28 34 30    { res.status(40
0750	30 29 3b 20 74 68 72 6f  77 20 6e 65 77 20 45 72   0); throw new Er
0760	72 6f 72 28 27 44 65 62  65 73 20 69 6e 64 69 63   ror('Debes indic
0770	61 72 20 74 75 20 63 6f  6e 74 72 61 73 65 c3 83   ar tu contrase..
0780	c2 b1 61 20 61 63 74 75  61 6c 20 70 61 72 61 20   ..a actual para 
0790	63 61 6d 62 69 61 72 20  65 6c 20 63 6f 72 72 65   cambiar el corre
07a0	6f 27 29 3b 20 7d 0a 20  20 20 20 63 6f 6e 73 74   o'); }.    const
07b0	20 6f 6b 50 77 64 20 3d  20 61 77 61 69 74 20 62    okPwd = await b
07c0	63 72 79 70 74 2e 63 6f  6d 70 61 72 65 28 63 75   crypt.compare(cu
07d0	72 72 65 6e 74 50 61 73  73 77 6f 72 64 2c 20 75   rrentPassword, u
07e0	73 65 72 2e 70 61 73 73  77 6f 72 64 29 3b 0a 20   ser.password);. 
07f0	20 20 20 69 66 20 28 21  6f 6b 50 77 64 29 20 7b      if (!okPwd) {
0800	20 72 65 73 2e 73 74 61  74 75 73 28 34 30 30 29    res.status(400)
0810	3b 20 74 68 72 6f 77 20  6e 65 77 20 45 72 72 6f   ; throw new Erro
0820	72 28 27 43 6f 6e 74 72  61 73 65 c3 83 c2 b1 61   r('Contrase....a
0830	20 61 63 74 75 61 6c 20  69 6e 63 6f 72 72 65 63    actual incorrec
0840	74 61 27 29 3b 20 7d 0a  20 20 20 20 75 73 65 72   ta'); }.    user
0850	2e 65 6d 61 69 6c 20 3d  20 6e 65 77 45 6d 61 69   .email = newEmai
0860	6c 3b 0a 20 20 7d 0a 0a  20 20 2f 2f 20 43 61 6d   l;.  }..  // Cam
0870	62 69 61 72 20 6e 6f 6d  62 72 65 0a 20 20 69 66   biar nombre.  if
0880	20 28 74 79 70 65 6f 66  20 6e 61 6d 65 20 3d 3d    (typeof name ==
0890	3d 20 27 73 74 72 69 6e  67 27 20 26 26 20 6e 61   = 'string' && na
08a0	6d 65 2e 74 72 69 6d 28  29 29 20 7b 0a 20 20 20   me.trim()) {.   
08b0	20 75 73 65 72 2e 6e 61  6d 65 20 3d 20 6e 61 6d    user.name = nam
08c0	65 2e 74 72 69 6d 28 29  3b 0a 20 20 7d 0a 0a 20   e.trim();.  }.. 
08d0	20 2f 2f 20 43 61 6d 62  69 61 72 20 63 6f 6e 74    // Cambiar cont
08e0	72 61 73 65 c3 83 c2 b1  61 20 28 72 65 71 75 69   rase....a (requi
08f0	65 72 65 20 63 75 72 72  65 6e 74 50 61 73 73 77   ere currentPassw
0900	6f 72 64 29 0a 20 20 69  66 20 28 74 79 70 65 6f   ord).  if (typeo
0910	66 20 6e 65 77 50 61 73  73 77 6f 72 64 20 3d 3d   f newPassword ==
0920	3d 20 27 73 74 72 69 6e  67 27 20 26 26 20 6e 65   = 'string' && ne
0930	77 50 61 73 73 77 6f 72  64 2e 6c 65 6e 67 74 68   wPassword.length
0940	20 3e 20 30 29 20 7b 0a  20 20 20 20 69 66 20 28    > 0) {.    if (
0950	21 63 75 72 72 65 6e 74  50 61 73 73 77 6f 72 64   !currentPassword
0960	29 20 7b 20 72 65 73 2e  73 74 61 74 75 73 28 34   ) { res.status(4
0970	30 30 29 3b 20 74 68 72  6f 77 20 6e 65 77 20 45   00); throw new E
0980	72 72 6f 72 28 27 44 65  62 65 73 20 69 6e 64 69   rror('Debes indi
0990	63 61 72 20 74 75 20 63  6f 6e 74 72 61 73 65 c3   car tu contrase.
09a0	83 c2 b1 61 20 61 63 74  75 61 6c 27 29 3b 20 7d   ...a actual'); }
09b0	0a 20 20 20 20 63 6f 6e  73 74 20 6f 6b 20 3d 20   .    const ok = 
09c0	61 77 61 69 74 20 62 63  72 79 70 74 2e 63 6f 6d   await bcrypt.com
09d0	70 61 72 65 28 63 75 72  72 65 6e 74 50 61 73 73   pare(currentPass
09e0	77 6f 72 64 2c 20 75 73  65 72 2e 70 61 73 73 77   word, user.passw
09f0	6f 72 64 29 3b 0a 20 20  20 20 69 66 20 28 21 6f   ord);.    if (!o
0a00	6b 29 20 7b 20 72 65 73  2e 73 74 61 74 75 73 28   k) { res.status(
0a10	34 30 30 29 3b 20 74 68  72 6f 77 20 6e 65 77 20   400); throw new 
0a20	45 72 72 6f 72 28 27 43  6f 6e 74 72 61 73 65 c3   Error('Contrase.
0a30	83 c2 b1 61 20 61 63 74  75 61 6c 20 69 6e 63 6f   ...a actual inco
0a40	72 72 65 63 74 61 27 29  3b 20 7d 0a 20 20 20 20   rrecta'); }.    
0a50	63 6f 6e 73 74 20 72 6f  75 6e 64 73 20 3d 20 70   const rounds = p
0a60	61 72 73 65 49 6e 74 28  70 72 6f 63 65 73 73 2e   arseInt(process.
0a70	65 6e 76 2e 42 43 52 59  50 54 5f 52 4f 55 4e 44   env.BCRYPT_ROUND
0a80	53 20 7c 7c 20 27 31 30  27 2c 20 31 30 29 3b 0a   S || '10', 10);.
0a90	20 20 20 20 63 6f 6e 73  74 20 73 61 6c 74 20 3d       const salt =
0aa0	20 61 77 61 69 74 20 62  63 72 79 70 74 2e 67 65    await bcrypt.ge
0ab0	6e 53 61 6c 74 28 4e 75  6d 62 65 72 2e 69 73 46   nSalt(Number.isF
0ac0	69 6e 69 74 65 28 72 6f  75 6e 64 73 29 20 3f 20   inite(rounds) ? 
0ad0	72 6f 75 6e 64 73 20 3a  20 31 30 29 3b 0a 20 20   rounds : 10);.  
0ae0	20 20 75 73 65 72 2e 70  61 73 73 77 6f 72 64 20     user.password 
0af0	3d 20 61 77 61 69 74 20  62 63 72 79 70 74 2e 68   = await bcrypt.h
0b00	61 73 68 28 6e 65 77 50  61 73 73 77 6f 72 64 2c   ash(newPassword,
0b10	20 73 61 6c 74 29 3b 0a  20 20 7d 0a 0a 20 20 61    salt);.  }..  a
0b20	77 61 69 74 20 75 73 65  72 2e 73 61 76 65 28 29   wait user.save()
0b30	3b 0a 0a 20 20 72 65 73  2e 6a 73 6f 6e 28 7b 20   ;..  res.json({ 
0b40	5f 69 64 3a 20 75 73 65  72 2e 69 64 2c 20 6e 61   _id: user.id, na
0b50	6d 65 3a 20 75 73 65 72  2e 6e 61 6d 65 2c 20 65   me: user.name, e
0b60	6d 61 69 6c 3a 20 75 73  65 72 2e 65 6d 61 69 6c   mail: user.email
0b70	2c 20 72 6f 6c 65 3a 20  75 73 65 72 2e 72 6f 6c   , role: user.rol
0b80	65 20 7d 29 3b 0a 7d 29  3b 0a 0a 6d 6f 64 75 6c   e });.});..modul
0b90	65 2e 65 78 70 6f 72 74  73 2e 75 70 64 61 74 65   e.exports.update
0ba0	4d 65 20 3d 20 75 70 64  61 74 65 4d 65 3b 0a 0a   Me = updateMe;..
0bb0	2f 2f 20 40 64 65 73 63  20 20 20 20 43 6f 6d 70   // @desc    Comp
0bc0	72 6f 62 61 72 20 73 69  20 75 6e 20 65 6d 61 69   robar si un emai
0bd0	6c 20 65 73 74 c3 83 c2  a1 20 64 69 73 70 6f 6e   l est.... dispon
0be0	69 62 6c 65 20 28 65 78  63 6c 75 79 65 6e 64 6f   ible (excluyendo
0bf0	20 65 6c 20 64 65 6c 20  70 72 6f 70 69 6f 20 75    el del propio u
0c00	73 75 61 72 69 6f 29 0a  2f 2f 20 40 72 6f 75 74   suario).// @rout
0c10	65 20 20 20 47 45 54 20  2f 61 70 69 2f 75 73 65   e   GET /api/use
0c20	72 73 2f 63 68 65 63 6b  2d 65 6d 61 69 6c 3f 65   rs/check-email?e
0c30	6d 61 69 6c 3d 2e 2e 2e  0a 2f 2f 20 40 61 63 63   mail=....// @acc
0c40	65 73 73 20 20 50 72 69  76 61 64 6f 0a 63 6f 6e   ess  Privado.con
0c50	73 74 20 63 68 65 63 6b  45 6d 61 69 6c 55 6e 69   st checkEmailUni
0c60	71 75 65 20 3d 20 61 73  79 6e 63 48 61 6e 64 6c   que = asyncHandl
0c70	65 72 28 61 73 79 6e 63  20 28 72 65 71 2c 20 72   er(async (req, r
0c80	65 73 29 20 3d 3e 20 7b  0a 20 20 63 6f 6e 73 74   es) => {.  const
0c90	20 65 6d 61 69 6c 20 3d  20 53 74 72 69 6e 67 28    email = String(
0ca0	72 65 71 2e 71 75 65 72  79 2e 65 6d 61 69 6c 20   req.query.email 
0cb0	7c 7c 20 27 27 29 2e 74  72 69 6d 28 29 2e 74 6f   || '').trim().to
0cc0	4c 6f 77 65 72 43 61 73  65 28 29 3b 0a 20 20 69   LowerCase();.  i
0cd0	66 20 28 21 65 6d 61 69  6c 29 20 72 65 74 75 72   f (!email) retur
0ce0	6e 20 72 65 73 2e 6a 73  6f 6e 28 7b 20 61 76 61   n res.json({ ava
0cf0	69 6c 61 62 6c 65 3a 20  66 61 6c 73 65 2c 20 72   ilable: false, r
0d00	65 61 73 6f 6e 3a 20 27  65 6d 70 74 79 27 20 7d   eason: 'empty' }
0d10	29 3b 0a 20 20 63 6f 6e  73 74 20 65 78 69 73 74   );.  const exist
0d20	73 20 3d 20 61 77 61 69  74 20 55 73 65 72 2e 66   s = await User.f
0d30	69 6e 64 4f 6e 65 28 7b  20 65 6d 61 69 6c 2c 20   indOne({ email, 
0d40	5f 69 64 3a 20 7b 20 24  6e 65 3a 20 72 65 71 2e   _id: { $ne: req.
0d50	75 73 65 72 2e 5f 69 64  20 7d 20 7d 29 2e 73 65   user._id } }).se
0d60	6c 65 63 74 28 27 5f 69  64 27 29 2e 6c 65 61 6e   lect('_id').lean
0d70	28 29 3b 0a 20 20 72 65  73 2e 6a 73 6f 6e 28 7b   ();.  res.json({
0d80	20 61 76 61 69 6c 61 62  6c 65 3a 20 21 42 6f 6f    available: !Boo
0d90	6c 65 61 6e 28 65 78 69  73 74 73 29 20 7d 29 3b   lean(exists) });
0da0	0a 7d 29 3b 0a 0a 6d 6f  64 75 6c 65 2e 65 78 70   .});..module.exp
0db0	6f 72 74 73 2e 63 68 65  63 6b 45 6d 61 69 6c 55   orts.checkEmailU
0dc0	6e 69 71 75 65 20 3d 20  63 68 65 63 6b 45 6d 61   nique = checkEma
0dd0	69 6c 55 6e 69 71 75 65  3b 0a 0a 2f 2f 20 40 64   ilUnique;..// @d
0de0	65 73 63 20 20 20 20 41  63 74 75 61 6c 69 7a 61   esc    Actualiza
0df0	72 20 61 76 61 74 61 72  20 64 65 6c 20 75 73 75   r avatar del usu
0e00	61 72 69 6f 20 61 75 74  65 6e 74 69 63 61 64 6f   ario autenticado
0e10	0a 2f 2f 20 40 72 6f 75  74 65 20 20 20 50 55 54   .// @route   PUT
0e20	20 2f 61 70 69 2f 75 73  65 72 73 2f 6d 65 2f 61    /api/users/me/a
0e30	76 61 74 61 72 0a 2f 2f  20 40 61 63 63 65 73 73   vatar.// @access
0e40	20 20 50 72 69 76 61 64  6f 20 28 6d 75 6c 74 69     Privado (multi
0e50	70 61 72 74 2f 66 6f 72  6d 2d 64 61 74 61 20 63   part/form-data c
0e60	6f 6e 20 63 61 6d 70 6f  20 27 61 76 61 74 61 72   on campo 'avatar
0e70	27 29 0a 63 6f 6e 73 74  20 75 70 64 61 74 65 41   ').const updateA
0e80	76 61 74 61 72 20 3d 20  61 73 79 6e 63 48 61 6e   vatar = asyncHan
0e90	64 6c 65 72 28 61 73 79  6e 63 20 28 72 65 71 2c   dler(async (req,
0ea0	20 72 65 73 29 20 3d 3e  20 7b 0a 20 20 69 66 20    res) => {.  if 
0eb0	28 21 72 65 71 2e 66 69  6c 65 29 20 7b 20 72 65   (!req.file) { re
0ec0	73 2e 73 74 61 74 75 73  28 34 30 30 29 3b 20 74   s.status(400); t
0ed0	68 72 6f 77 20 6e 65 77  20 45 72 72 6f 72 28 27   hrow new Error('
0ee0	4e 6f 20 73 65 20 72 65  63 69 62 69 c3 83 c2 b3   No se recibi....
0ef0	20 69 6d 61 67 65 6e 27  29 3b 20 7d 0a 20 20 63    imagen'); }.  c
0f00	6f 6e 73 74 20 6d 69 6d  65 20 3d 20 72 65 71 2e   onst mime = req.
0f10	66 69 6c 65 2e 6d 69 6d  65 74 79 70 65 20 7c 7c   file.mimetype ||
0f20	20 27 27 3b 0a 20 20 69  66 20 28 21 6d 69 6d 65    '';.  if (!mime
0f30	2e 73 74 61 72 74 73 57  69 74 68 28 27 69 6d 61   .startsWith('ima
0f40	67 65 2f 27 29 29 20 7b  20 72 65 73 2e 73 74 61   ge/')) { res.sta
0f50	74 75 73 28 34 30 30 29  3b 20 74 68 72 6f 77 20   tus(400); throw 
0f60	6e 65 77 20 45 72 72 6f  72 28 27 45 6c 20 61 72   new Error('El ar
0f70	63 68 69 76 6f 20 64 65  62 65 20 73 65 72 20 75   chivo debe ser u
0f80	6e 61 20 69 6d 61 67 65  6e 27 29 3b 20 7d 0a 20   na imagen'); }. 
0f90	20 69 66 20 28 72 65 71  2e 66 69 6c 65 2e 73 69    if (req.file.si
0fa0	7a 65 20 3e 20 32 20 2a  20 31 30 32 34 20 2a 20   ze > 2 * 1024 * 
0fb0	31 30 32 34 29 20 7b 20  72 65 73 2e 73 74 61 74   1024) { res.stat
0fc0	75 73 28 34 30 30 29 3b  20 74 68 72 6f 77 20 6e   us(400); throw n
0fd0	65 77 20 45 72 72 6f 72  28 27 4c 61 20 69 6d 61   ew Error('La ima
0fe0	67 65 6e 20 73 75 70 65  72 61 20 32 4d 42 27 29   gen supera 2MB')
0ff0	3b 20 7d 0a 0a 20 20 63  6f 6e 73 74 20 64 62 78   ; }..  const dbx
1000	20 3d 20 61 77 61 69 74  20 67 65 74 44 72 6f 70    = await getDrop
1010	62 6f 78 43 6c 69 65 6e  74 28 29 3b 0a 20 20 63   boxClient();.  c
1020	6f 6e 73 74 20 6e 6f 77  20 3d 20 44 61 74 65 2e   onst now = Date.
1030	6e 6f 77 28 29 3b 0a 20  20 63 6f 6e 73 74 20 65   now();.  const e
1040	78 74 20 3d 20 6d 69 6d  65 2e 73 70 6c 69 74 28   xt = mime.split(
1050	27 2f 27 29 5b 31 5d 20  7c 7c 20 27 70 6e 67 27   '/')[1] || 'png'
1060	3b 0a 20 20 63 6f 6e 73  74 20 66 69 6c 65 50 61   ;.  const filePa
1070	74 68 20 3d 20 60 2f 70  72 6f 79 65 63 74 69 66   th = `/proyectif
1080	79 69 61 2f 61 76 61 74  61 72 73 2f 24 7b 72 65   yia/avatars/${re
1090	71 2e 75 73 65 72 2e 5f  69 64 7d 5f 24 7b 6e 6f   q.user._id}_${no
10a0	77 7d 2e 24 7b 65 78 74  7d 60 3b 0a 0a 20 20 63   w}.${ext}`;..  c
10b0	6f 6e 73 74 20 75 70 6c  6f 61 64 65 64 20 3d 20   onst uploaded = 
10c0	61 77 61 69 74 20 64 62  78 2e 66 69 6c 65 73 55   await dbx.filesU
10d0	70 6c 6f 61 64 28 7b 20  70 61 74 68 3a 20 66 69   pload({ path: fi
10e0	6c 65 50 61 74 68 2c 20  63 6f 6e 74 65 6e 74 73   lePath, contents
10f0	3a 20 72 65 71 2e 66 69  6c 65 2e 62 75 66 66 65   : req.file.buffe
1100	72 2c 20 6d 6f 64 65 3a  20 7b 20 27 2e 74 61 67   r, mode: { '.tag
1110	27 3a 20 27 6f 76 65 72  77 72 69 74 65 27 20 7d   ': 'overwrite' }
1120	20 7d 29 3b 0a 20 20 63  6f 6e 73 74 20 73 68 61    });.  const sha
1130	72 65 64 20 3d 20 61 77  61 69 74 20 64 62 78 2e   red = await dbx.
1140	73 68 61 72 69 6e 67 43  72 65 61 74 65 53 68 61   sharingCreateSha
1150	72 65 64 4c 69 6e 6b 57  69 74 68 53 65 74 74 69   redLinkWithSetti
1160	6e 67 73 28 7b 20 70 61  74 68 3a 20 75 70 6c 6f   ngs({ path: uplo
1170	61 64 65 64 2e 72 65 73  75 6c 74 2e 70 61 74 68   aded.result.path
1180	5f 6c 6f 77 65 72 2c 20  73 65 74 74 69 6e 67 73   _lower, settings
1190	3a 20 7b 20 72 65 71 75  65 73 74 65 64 5f 76 69   : { requested_vi
11a0	73 69 62 69 6c 69 74 79  3a 20 27 70 75 62 6c 69   sibility: 'publi
11b0	63 27 20 7d 20 7d 29 3b  0a 20 20 63 6f 6e 73 74   c' } });.  const
11c0	20 75 72 6c 20 3d 20 73  68 61 72 65 64 2e 72 65    url = shared.re
11d0	73 75 6c 74 2e 75 72 6c  2e 72 65 70 6c 61 63 65   sult.url.replace
11e0	28 27 3f 64 6c 3d 30 27  2c 20 27 3f 72 61 77 3d   ('?dl=0', '?raw=
11f0	31 27 29 3b 0a 0a 20 20  61 77 61 69 74 20 55 73   1');..  await Us
1200	65 72 2e 75 70 64 61 74  65 4f 6e 65 28 7b 20 5f   er.updateOne({ _
1210	69 64 3a 20 72 65 71 2e  75 73 65 72 2e 5f 69 64   id: req.user._id
1220	20 7d 2c 20 7b 20 24 73  65 74 3a 20 7b 20 61 76    }, { $set: { av
1230	61 74 61 72 55 72 6c 3a  20 75 72 6c 20 7d 20 7d   atarUrl: url } }
1240	29 3b 0a 20 20 72 65 73  2e 6a 73 6f 6e 28 7b 20   );.  res.json({ 
1250	61 76 61 74 61 72 55 72  6c 3a 20 75 72 6c 20 7d   avatarUrl: url }
1260	29 3b 0a 7d 29 3b 0a 0a  6d 6f 64 75 6c 65 2e 65   );.});..module.e
1270	78 70 6f 72 74 73 2e 75  70 64 61 74 65 41 76 61   xports.updateAva
1280	74 61 72 20 3d 20 75 70  64 61 74 65 41 76 61 74   tar = updateAvat
1290	61 72 3b 0a                                        ar;.
